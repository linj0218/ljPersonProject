<!--
<p>This is the partial for view 2.</p>
<p>
	{{ welcomeMessage }}
	{{ip}}
</p>
<p>
	Showing of 'interpolate' filter:
	{{ 'Current version is v%VERSION%.' | interpolate }}
</p>-->
<!--<script src="./js/jquery.min.js"></script>-->
<!--<script src="./js/util.js"></script>-->

<!-- <link rel="stylesheet" type="text/css" href="css/weui.min.css"> -->
<style>
	.ngdialog-content {
		min-width: 1000px !important;
	}
	.show-area{
		font-size: 16px;
		height: 100%;
		background: #fff;
		margin: 50px auto;
		width: 100%;
		position: relative;
		z-index: 99;
	}
	.part-1{
		width: 100%;
	}
	.part-left, .part-right{
		width: 50%;
		display: inline-block;
		box-sizing: border-box;
		padding: 20px;
	}
	.part-left{
		padding-left: 50px;
	}
	.part-right{
		text-align: center;
	}
	.pl-1, .pl-4{
		font-weight: 600;
		font-size: 2rem;
		display: inline-block;
		vertical-align: bottom;
		width: 2rem;
		text-align: center;
		cursor: pointer;
	}
	.pl-2{
		font-size: 4rem;
		display: inline-block;
		vertical-align: bottom;
		width: 80px;
		text-align: center;
		line-height: 3.5rem;
		overflow: hidden;
		position: relative;
		height: 3.5rem;
	}
	.pl22{
		width: 960px;
		position: absolute;
		left: 0;
	}
	.pl22>a{
		display: inline-block;
		width: 80px;
		float: left;
	}
	.pl-3{
		font-size: 2rem;
		display: inline-block;
		vertical-align: bottom;
		width: 2rem;
	}
	.part-right>select{
		border: 1px solid #ccc;
		border-radius: 2px;
		box-sizing: border-box;
		color: #555;
		font-size: 2rem;
		min-width: 30%;
	}
	.part-2{
		text-align: center;
	}
	.part-2>table{
		width: 95%;
		margin: auto;
		border-collapse: collapse;
	}
	.part-2>table th{
		font-weight: 600;
		height: 5rem;
		line-height: 5rem;
		text-align: center;
	}
	.part-2>table td{
		border: 2px solid #111;
		position: relative;
		/*box-sizing: border-box;*/
		/*overflow: hidden;*/
	}
	.part-2>table tr:hover td{
		border-top: 3px solid #111;
		border-left: 3px solid #111;
		border-bottom: 3px solid #111;
	}
	.part-2>table td:hover{
		border: 3px solid #F7EBBB !important;
	}
	.part-2>table tr th:first-child,.part-2>table tr td:first-child{
		color: #f00;
	}
	.td-left, .td-right{
		float: left;
		box-sizing: border-box;
		/*overflow: hidden;*/
		white-space: nowrap;
		text-overflow: ellipsis;
	}
	.td-left{
		width: 40%;
		border-right: 1px solid #666;
		font-weight: 600;
		height: 70px;
		line-height: 65px;
		font-size: 2.5rem;
		padding: 5px;
		cursor: pointer;
		overflow: hidden;
	}
	.td-right{
		width: 60%;
		position: relative;
	}
	.td-right>a{
		display: block;
		font-size: 1rem;
		padding: 5px;
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
		cursor: pointer;
		text-align: left;
		height: 35px;
	}
	.td-right>a:nth-child(2n){
		border-top: 1px solid #666;
		box-sizing: border-box;
	}
	.color-blue{
		color: #2D80FF;
	}
	.show-box{
		display: none;
	}
	.show-box.on{
		display: block;
		position: absolute;
		top: -10px;
		left: 90%;
		background: #fff;
		/*width: 200px;*/
		z-index: 9;
		border: 2px solid #111;
		border-radius: 10px;
		color: #2D80FF;
		text-align: left;
		padding: 1rem;
		box-sizing: border-box;
		line-height: 1rem;
		font-size: 1rem;
	}
	.show-box.on>p {
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
	}
	.show-box.on>hr{
		margin: 5px 0;
		background: #111;
		height: 1px;
		border: none;
	}
	.show-box.on:after{
		content: '';
		border-width: 0 2px 2px 0;
		background: inherit;
		border-style: solid;
		border-color: #000;
		width: 1rem;
		height: 1rem;
		-webkit-transform: translateX(-50%) translateY(0) rotate(135deg);
		-moz-transform: translateX(-50%) translateY(0) rotate(135deg);
		-ms-transform: translateX(-50%) translateY(0) rotate(135deg);
		-o-transform: translateX(-50%) translateY(0) rotate(135deg);
		transform: translateX(-50%) translateY(0) rotate(135deg);
		top: 31px;
		left: -2px;
		position: absolute;
		z-index: 1;
	}
	#popup{
		position: absolute;
		z-index: 9;
		left: -20px;
		top: -10px;
		height: 90px;
		border: 2px solid #111;
		box-sizing: border-box;
		width: 130%;
		overflow: hidden;
		background: #eee;
	}
	#popup input{
		height: 2rem;
		width: 2rem;
		border: none;
		border-bottom: 1px solid #555;
		background: inherit;
	}
	.inp-l{
		text-align: right;
	}
	.pop-left{
		border-right: 2px solid #111;
		box-sizing: border-box;
		display: inline-block;
		font-size: 4rem;
		font-weight: 600;
		height: 90px;
		line-height: 90px;
		width: 30%;
	}
	.pop-right{
		vertical-align: top;
		display: inline-block;
		width: 70%;
	}
	.pop-pr1{
		display: block;
		height: 45px;
		line-height: 45px;
		border-bottom: 1px solid #111;
		box-sizing: border-box;
		color: #555;
	}
	.pop-pr2{
		display: block;
		height: 45px;
		line-height: 45px;
	}
	.pop-pr2>a{
		display: inline-block;
		width: 50%;
		height: 100%;
		font-weight: 600;
		cursor: pointer;
	}
	.btn-del{
		border-right: 1px solid #111;
		box-sizing: border-box;
		color: #f00;
	}
	.btn-add{
		color: limegreen;
	}
	.can-edit{
		background: #8DEABB;
	}
	.cant-edit{
		background: #F68483;
	}
	.in-edit{
		background: #8CAAF2;
	}
	.sele-box{
		position: absolute;
		right: 0;
		width: 100%;
		height: 100%;
		top: 0;
		z-index: 9;
	}
	.sele-box>select{
		width: 100%;
		height: 100%;
		background: inherit;
		border: none;
		color: #111;
	}
	.part-3{
		text-align: right;
	}
	.part-3>button{
		margin-right: 10%;
		margin-top: 20px;
	}
</style>
<div class="show-area">
	<div class="part-1">
		<div class="part-left">
			<span class="pl-1"><</span>
				<span class="pl-2">
					<div class="pl22">
						<a>01</a>
						<a>02</a>
						<a>03</a>
						<a>04</a>
						<a>05</a>
						<a>06</a>
						<a>07</a>
						<a>08</a>
						<a>09</a>
						<a>10</a>
						<a>11</a>
						<a>12</a>
					</div>
				</span>
			<span class="pl-3">月</span>
			<span class="pl-4">></span>
		</div><!--
			--><div class="part-right">
		<select>
			<!--<option>1</option>
			<option>2</option>
			<option>3</option>-->
		</select>
		<!--<select>
            <option>1</option>
            <option>2</option>
            <option>3</option>
        </select>-->
	</div>
	</div>
	<div class="part-2">
		<table>
			<thead>
			<tr>
				<th>星期天</th>
				<th>星期一</th>
				<th>星期二</th>
				<th>星期三</th>
				<th>星期四</th>
				<th>星期五</th>
				<th>星期六</th>
			</tr>
			</thead>
			<tbody>

			</tbody>
		</table>
	</div>
	<div class="part-3">
		<button class="btn btn-primary" id="btn-sub">提交修改</button>
	</div>
</div>
<script>
	var thisData   = {};
	var is_scroll  = false;
	var now_month  = "";
	var now_store  = "";
	var tempDay    = 0;
	var trs        = 5;
	var tds        = 7;
	var table      = [];
	var first      = 0;
	var len        = 0;
	var utype      = 0;
	var cmoid      = 0;
	var tempObjInf = {
		"cmoid" : 0,
		"cmostoreid" : 0,        // 店铺id
		"cmorderdate" : "",      // 日期
		"cmotsid" : 0,           // 技师id
		"cmordertime" : "",      // 上午
		"cmafterordertime" : ""  // 下午
	};
	var mObj = function(){
		this.tBody     = document.getElementsByClassName("part-2")[0].getElementsByTagName("tbody")[0];
		this.turnRight = document.getElementsByClassName("pl-1")[0];
		this.turnLeft  = document.getElementsByClassName("pl-4")[0];
	};
	mObj.prototype = {
		init      : function(data){
			thisData  = data;
			first     = parseInt(data.monthFirstWeekDate);
			len       = parseInt(data.monthLastDate);
			now_store = data.cmostoreid;
			utype     = data.utype;
			cmoid     = data.cmoid;

			this.initPage();
			this.getStoreList();
		},
		initPage  : function(){
			var mainThis  = this;
			var n         = parseInt(thisData.orderMonth);

			// 月份
			$(".pl22").css("left","-"+$(".pl22>a").width()*(n-1)+"px");

			for(var i=0; i<trs; i++){
				table.push("<tr>");
				for(var j=0; j<tds; j++){
					if(i==0 && j==first && tempDay ==0){
						var _html = mainThis.loadHtml(i,j);
						table.push(_html);
					}else if(tempDay !=0 && tempDay<len){
						var _html = mainThis.loadHtml(i,j);
						table.push(_html);
					}else{
						var html = "" +
								"<td id=\"td-"+i+"-"+j+"\">" +
								"	<div class=\"td-left\" style='color: #fff;'>.</div>" +
								"	<div class=\"td-right\"></div>" +
								"</td>";
						table.push(html);
					}
				}
				table.push("</tr>");
			}

			mainThis.tBody.innerHTML = table.join("");
			mainThis.loadData();

			this.eventBind();
		},
		// 日历画面
		loadHtml  : function(i,j){
			var mainThis = this;
			var html = "" +
					"<td class=\"act\" id=\"td-"+i+"-"+j+"\">" +
					"	<div class=\"td-left\">"+(++tempDay)+"</div>" +
					"	<div class=\"td-right\">" +
					"		<a class='color-blue' data-start=\"\" data-end=\"\"></a>" +
					"		<a class='color-blue' data-start=\"\" data-end=\"\"></a>" +
					/*"		<div class=\"show-box\">" +
					"			<p>小郑 上午12:20-13:30</p>" +
					"			<p>徐汇规则车行</p>" +
					"           <hr>" +
					"			<p>小郑 上午12:20-13:30</p>" +
					"			<p>徐汇规则车行</p>" +
					"		</div>" +*/
					"	</div>" +
					"</td>";
			return html;
		},
		// 加载日历数据
		loadData  : function(){
			for(var i=0; i<thisData.memorderdatelist.length; i++){
				for(var j=0; j<len; j++){
					var v1 = parseInt(thisData.memorderdatelist[i].monthorderdate);
					var v2 = parseInt($(".act .td-left").eq(j).html());

					if(v1 == v2){
						if(thisData.memorderdatelist[i].cuurmodatetype == 0 && !$(".act").eq(j).hasClass("cant-edit")){
							$(".act").eq(j).addClass("cant-edit");
						}else if(thisData.memorderdatelist[i].cuurmodatetype == 1 && !$(".act").eq(j).hasClass("can-edit")){
							$(".act").eq(j).addClass("can-edit");
						}
						if(thisData.memorderdatelist[i].ordertimeType == 0){
							$(".act .td-right").eq(j).find("a").eq(0)
									.attr("cmotsid",thisData.memorderdatelist[i].cmotsid)
									.attr("data-start",thisData.memorderdatelist[i].cmordertime.split("-")[0])
									.attr("data-end", thisData.memorderdatelist[i].cmordertime.split("-")[1])
									.html(thisData.memorderdatelist[i].tsname);

							if( !!$(".act .td-right").eq(j).find(".show-box").length ){
								var html = "" +
									"	<hr>" +
									"	<p>"+thisData.memorderdatelist[i].tsname+" 上午 "+thisData.memorderdatelist[i].cmordertime+"</p>" +
									"	<p>"+thisData.memorderdatelist[i].sstorename+"</p>";
								$(".act .td-right").eq(j).find(".show-box").append(html);
							}else {
								var html = "" +
									"<div class=\"show-box\">" +
									"	<p>"+thisData.memorderdatelist[i].tsname+" 上午 "+thisData.memorderdatelist[i].cmordertime+"</p>" +
									"	<p>"+thisData.memorderdatelist[i].sstorename+"</p>" +
									"</div>";
								$(".act .td-right").eq(j).append(html);
							}
						}else if(thisData.memorderdatelist[i].ordertimeType == 1){
							$(".act .td-right").eq(j).find("a").eq(1)
									.attr("cmotsid",thisData.memorderdatelist[i].cmotsid)
									.attr("data-start",thisData.memorderdatelist[i].cmordertime.split("-")[0])
									.attr("data-end", thisData.memorderdatelist[i].cmordertime.split("-")[1])
									.html(thisData.memorderdatelist[i].tsname);

							if( !!$(".act .td-right").eq(j).find(".show-box").length ){
								var html = "" +
										"	<hr>" +
										"	<p>"+thisData.memorderdatelist[i].tsname+" 下午 "+thisData.memorderdatelist[i].cmordertime+"</p>" +
										"	<p>"+thisData.memorderdatelist[i].sstorename+"</p>";
								$(".act .td-right").eq(j).find(".show-box").append(html);
							}else {
								var html = "" +
										"<div class=\"show-box\">" +
										"	<p>"+thisData.memorderdatelist[i].tsname+" 下午 "+thisData.memorderdatelist[i].cmordertime+"</p>" +
										"	<p>"+thisData.memorderdatelist[i].sstorename+"</p>" +
										"</div>";
								$(".act .td-right").eq(j).append(html);
							}
						}
						if(i==thisData.memorderdatelist.length-1){
							break;
						}
					}

				}
			}
		},
		eventBind : function(){
			var mainThis = this;

			$(".part-2>table td").hover(function(){
				$(this).find(".show-box").addClass("on");
			},function(){
				$(this).find(".show-box").removeClass("on");
			});

			this.turnLeft.onclick = function(){
				mainThis.scroll(0);
			};

			this.turnRight.onclick = function(){
				mainThis.scroll(1);
			};

			$(".td-right>a").unbind("click").on("click",function(){
				$(".part-2>table td").unbind("mouseenter").unbind("mouseleave");
				$(".show-box").removeClass("on");

				var $this  = $(this);
				var _date  = $(this).parent().prev().html();
				var _time1 = !$(this).attr("data-start")?"0:0":$(this).attr("data-start");
				var _time2 = !$(this).attr("data-end") ? "0:0":$(this).attr("data-end");

				$("#popup").remove();
				var html   = mainThis.loadPop(_date,_time1,_time2);

				$(this).parent().parent().append(html);

				document.getElementsByClassName("btn-del")[0].onclick = function(){
					mainThis.eventBind();
					$("#popup").remove();
				};
				document.getElementsByClassName("btn-add")[0].onclick = function(){

					$this.attr("data-start",$(".inp-1").val()+":"+$(".inp-2").val());
					$this.attr("data-end",$(".inp-3").val()+":"+$(".inp-4").val());
					$("#popup").remove();

					var html = mainThis.loadSele();
					$this.parent().append(html);

					$("#btn-sub").unbind("click").on("click",function(){
						$this.html($(".sele-box:selected").html());
						$(".sele-box").remove();
						mainThis.eventBind();
					});
				}
			});

			$(".part-right>select").on("change",function(){
				mainThis.flashPage();
			});
		},
		getStoreList : function(){
			var mainThis = this;
			httputil.httpget("/morder/QueryCcStoreList", {}, mainThis.getStoreListCallBack);
		},
		getStoreListCallBack : function(data){
			console.log(data);
			var data = data.data;
			var html = "";
			for(var i=0; i<data.length; i++){
				html += "<option data-storeid=\""+data[i].sid+"\" value=\""+data[i].sid+"\">"+data[i].sstorename+"</option>";
			}
			$(".part-right>select").html(html).val(now_store);
		},
		loadPop   : function(d,t1,t2){
			var html = ""+
					"<div id=\"popup\">" +
					"	<span class=\"pop-left\">"+(d)+"</span><!--" +
					"	--><span class=\"pop-right\">" +
					"		<span class=\"pop-pr1\">" +
					"			<input class='inp-l inp-1' value=\""+(t1.split(':')[0])+"\">:<input class='inp-2' value=\""+(t1.split(':')[1])+"\">-<input class='inp-l inp-3' value=\""+(t2.split(':')[0])+"\">:<input class='inp-4' value=\""+(t2.split(':')[1])+"\">" +
					"		</span>" +
					"		<span class=\"pop-pr2\">" +
					"			<a class='btn-del'>×</a><a class='btn-add'>√</a>" +
					"		</span>" +
					"	</span>" +
					"</div>";
			return html;
		},
		loadSele  : function(){
			var reqData = {
				"cmorderdate" : "2016"+now_month
			};
			httputil.httpget("/morder/QueryCcTechnologyStaffList", reqData, function(res){
				console.log(res);
			});
			var html = "" +
					"<div class='sele-box in-edit'>" +
					"	<select>" +
					"		<option>张军</option>" +
					"		<option>张三</option>" +
					"		<option>小四</option>" +
					"	</select>" +
					"</div>";
			return html;
		},
		scroll    : function(flg){
			var mainThis = this;
			// 0,往左 1,往右
			if(is_scroll){
				return false;
			}
			var _left = parseInt($(".pl22").css("left"));
			if(flg == 0){
				if(_left + $(".pl22").width() > 80){
					is_scroll = true;
					$(".pl22").animate({"left":"-="+$(".pl22>a").width()},500,function(){is_scroll=false;mainThis.flashPage();});
				}
			}else if(flg == 1){
				if(_left < 0){
					is_scroll = true;
					$(".pl22").animate({"left":"+="+$(".pl22>a").width()},500,function(){is_scroll=false;mainThis.flashPage();});
				}
			}
		},
		flashPage : function(){
			var cmostoreid = parseInt($(".part-right>select").val());
			var monthNum   = Math.abs($(".pl22").css("left").substr(0,$(".pl22").css("left").length-2))/80;
			var monthStr   = $(".pl22 a").eq(monthNum).html();

			var reqData = {
				"cmoid"      : cmoid,
				"utype"      : utype,             //修改类型1:日期修改，2时间修改，3员工修改，4店铺修改
				"cmostoreid" : cmostoreid,        //选择修改店铺后传
				"orderym"    : "2016" + monthStr  //选择上下月后传YM 如201605
			};
			httputil.httpget("/morder/GetOrderPartInfo", reqData, function(res){
				console.log(res);
			});
		}
	};

</script>